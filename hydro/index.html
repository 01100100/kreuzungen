<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapLibre Demo</title>
    <link href="https://unpkg.com/maplibre-gl@1.15.2/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/maplibre-gl@1.15.2/dist/maplibre-gl.js"></script>
    <script>
        // Initialize the map
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                "version": 8,
                "sources": {
                    "maplibre": {
                        "type": "vector",
                        "url": "https://demotiles.maplibre.org/tiles/tiles.json"
                    }
                },
                "layers": [
                    {
                        "id": "background",
                        "type": "background",
                        "paint": {
                            "background-color": "#D8F2FF"
                        }
                    },
                    {
                        "id": "countries-fill",
                        "type": "fill",
                        "source": "maplibre",
                        "source-layer": "countries",
                        "paint": {
                            "fill-color": "#EAB38F"
                        }
                    },
                    {
                        "id": "countries-boundary",
                        "type": "line",
                        "source": "maplibre",
                        "source-layer": "countries",
                        "paint": {
                            "line-color": "rgba(255, 255, 255, 1)",
                            "line-width": 1
                        }
                    }
                ]
            },
            center: [17.65431710431244, 32.954120326746775],
            zoom: 0.8619833357855968
        });

        // Fetch the waterways data
        fetch('https://fly.storage.tigris.dev/hydro-xpid/modelled/country.json')
            .then(response => response.text()) // Fetch as text to handle NDJSON
            .then(text => {
                try {
                    // Split the NDJSON text by newlines and parse each line
                    const data = text.split('\n').filter(line => line.trim() !== '').map(line => JSON.parse(line));
                    // Convert waterways data to a dictionary for easy lookup
                    const waterwaysDict = data.reduce((acc, country) => {
                        acc[country.country_code_3] = {
                            waterways_crossed: country.waterways_crossed,
                            unique_waterways_crossed: country.unique_waterways_crossed,
                            country_name: country.country
                        };
                        return acc;
                    }, {});
                    console.log('Waterways data:', waterwaysDict);

                    // Update the map style
                    map.on('load', () => {
                        map.setPaintProperty('countries-fill', 'fill-color', [
                            'match',
                            ['get', 'ADM0_A3'],
                            ...Object.entries(waterwaysDict).flatMap(([countryCode, { waterways_crossed }]) => [
                                countryCode,
                                `rgba(0, 0, 255, ${Math.min(0.3 + waterways_crossed * 0.02, 0.9)})`
                            ]),
                            'rgba(0, 0, 255, 0.3)' // Default color
                        ]);

                        let hoveredCountryId = null;
                        const popup = new maplibregl.Popup({
                            closeButton: false,
                            closeOnClick: false
                        });

                        map.on('mousemove', 'countries-fill', (e) => {
                            if (e.features.length > 0) {
                                if (hoveredCountryId) {
                                    map.setFeatureState(
                                        { source: 'maplibre', sourceLayer: 'countries', id: hoveredCountryId },
                                        { hover: false }
                                    );
                                }
                                hoveredCountryId = e.features[0].id;
                                map.setFeatureState(
                                    { source: 'maplibre', sourceLayer: 'countries', id: hoveredCountryId },
                                    { hover: true }
                                );

                                const countryCode = e.features[0].properties.ADM0_A3;
                                const countryData = waterwaysDict[countryCode];
                                const countryName = e.features[0].properties.ADMIN;

                                if (countryData) {
                                    popup.setLngLat(e.lngLat)
                                        .setHTML(`
                                            <strong>${countryData.country_name}</strong><br>
                                            Waterways Crossed: ${countryData.waterways_crossed}<br>
                                            Unique Waterways Crossed: ${countryData.unique_waterways_crossed}
                                        `)
                                        .addTo(map);
                                } else {
                                    popup.setLngLat(e.lngLat)
                                        .setHTML(`
                                            <strong>${countryName}</strong><br>
                                            No waterway data available
                                        `)
                                        .addTo(map);
                                }
                            }
                        });

                        map.on('mouseleave', 'countries-fill', () => {
                            if (hoveredCountryId) {
                                map.setFeatureState(
                                    { source: 'maplibre', sourceLayer: 'countries', id: hoveredCountryId },
                                    { hover: false }
                                );
                            }
                            hoveredCountryId = null;
                            popup.remove();
                        });

                        map.addLayer({
                            id: 'countries-hover',
                            type: 'fill',
                            source: 'maplibre',
                            'source-layer': 'countries',
                            paint: {
                                'fill-color': [
                                    'case',
                                    ['boolean', ['feature-state', 'hover'], false],
                                    [
                                        'match',
                                        ['get', 'ADM0_A3'],
                                        ...Object.entries(waterwaysDict).flatMap(([country_code_3, { waterways_crossed }]) => [
                                            country_code_3,
                                            `rgba(0, 0, 255, ${Math.min(0.3 + waterways_crossed * 0.02, 0.9)})`
                                        ]),
                                        'rgba(0, 0, 255, 0.2)' // Default hover color
                                    ],
                                    [
                                        'match',
                                        ['get', 'ADM0_A3'],
                                        ...Object.entries(waterwaysDict).flatMap(([country_code_3, { waterways_crossed }]) => [
                                            country_code_3,
                                            `rgba(0, 0, 255, ${Math.min(0.3 + waterways_crossed * 0.02, 0.9) - 0.1})`
                                        ]),
                                        'rgba(0, 0, 255, 0.3)' // Default color
                                    ]
                                ],
                                'fill-opacity': 0.6
                            }
                        }, 'countries-boundary'); // Ensure the hover layer is below the boundary layer
                    });
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    console.log('Raw response text:', text); // Log the raw response for inspection
                }
            })
            .catch(error => console.error('Error fetching waterways data:', error));
    </script>
</body>
</html>